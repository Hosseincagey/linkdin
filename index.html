<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>سیستم مدیریت حرفه‌ای لینکدین</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <style>
    @font-face {
      font-family: 'Vazir';
      src: url('https://cdn.jsdelivr.net/gh/rastikerdar/vazir-font@v30.1.0/dist/Vazir.woff2') format('woff2');
    }
    body {
      font-family: 'Vazir', sans-serif;
    }
    .linkedin-auth {
      background-color: #0A66C2;
    }
    .linkedin-auth:hover {
      background-color: #004182;
    }
    .service-unavailable {
      background-color: #fef3c7;
      border-left: 4px solid #f59e0b;
    }
  </style>
</head>
<body class="bg-gray-50">
  <div class="max-w-6xl mx-auto p-4 md:p-6 space-y-6">
    
    <!-- Header -->
    <header class="text-center py-6">
      <h1 class="text-2xl md:text-3xl font-bold text-[#0A66C2]">مدیریت حرفه‌ای لینکدین</h1>
      <p class="text-gray-600 mt-2">اتصال هوشمند رزومه، تولید محتوا و تحلیل پیشرفته</p>
    </header>

    <!-- LinkedIn Auth Section -->
    <section class="bg-white rounded-xl shadow-sm p-6">
      <h2 class="text-xl font-semibold text-gray-800 mb-4">اتصال به حساب لینکدین</h2>
      <div id="authSection">
        <button id="linkedInAuth" class="linkedin-auth flex items-center justify-center w-full max-w-xs mx-auto text-white font-medium py-2.5 px-4 rounded-lg transition duration-200">
          <i class="fab fa-linkedin-in ml-2 text-lg"></i>
          <span>اتصال با لینکدین</span>
        </button>
        <p class="text-sm text-gray-500 mt-3">برای استفاده از تمام قابلیت‌ها، لطفاً حساب لینکدین خود را متصل کنید</p>
      </div>
      
      <!-- Service Unavailable Message -->
      <div id="serviceUnavailable" class="hidden mt-4 p-4 rounded-lg service-unavailable">
        <div class="flex items-start">
          <i class="fas fa-exclamation-triangle text-yellow-600 mt-1 ml-2"></i>
          <div>
            <h3 class="font-medium text-yellow-800">سرویس LinkedIn موقتاً در دسترس نیست</h3>
            <p class="text-sm text-yellow-700 mt-1">سرورهای LinkedIn در حال حاضر پاسخگو نیستند. لطفاً چند دقیقه دیگر مجدداً تلاش کنید.</p>
            <div class="mt-3 flex items-center text-sm text-yellow-800">
              <i class="fas fa-sync-alt ml-2"></i>
              <span id="retryCounter">تلاش مجدد در 30 ثانیه...</span>
            </div>
          </div>
        </div>
      </div>
      
      <div id="profileSection" class="hidden mt-4 p-4 bg-gray-50 border rounded-lg">
        <!-- Profile content remains the same -->
      </div>
    </section>

  </div>

  <script>
    // ==================== تنظیمات اتصال به LinkedIn ====================
    const LINKEDIN_CONFIG = {
      CLIENT_ID: '78iihkedifumfl',
      CLIENT_SECRET: 'WPL_AP1.Oqh5rNxg9fLnm2zf.4D/X4g==',
      REDIRECT_URI: encodeURIComponent('https://hosseincagey.github.io/linkdin/auth'),
      SCOPE: encodeURIComponent('r_liteprofile r_emailaddress'),
      STATE: '123456',
      HEALTH_CHECK_INTERVAL: 30000, // هر 30 ثانیه چک شود
      MAX_RETRIES: 5
    };

    // ==================== عناصر DOM ====================
    const authBtn = document.getElementById('linkedInAuth');
    const profileSection = document.getElementById('profileSection');
    const logoutBtn = document.getElementById('logoutBtn');
    const serviceUnavailable = document.getElementById('serviceUnavailable');
    const retryCounter = document.getElementById('retryCounter');
    
    let retryCount = 0;
    let retryTimer;

    // ==================== بررسی سلامت سرویس LinkedIn ====================
    async function checkLinkedInHealth() {
      try {
        // استفاده از endpoint سلامت LinkedIn
        const response = await fetch('https://www.linkedin.com/health', {
          method: 'GET',
          mode: 'no-cors',
          cache: 'no-cache'
        });
        
        // اگر پاسخ دریافت شد (حتی اگر خطا باشد) یعنی سرویس فعال است
        serviceUnavailable.classList.add('hidden');
        authBtn.disabled = false;
        retryCount = 0;
        clearTimeout(retryTimer);
        return true;
      } catch (error) {
        console.error('خطا در بررسی سلامت LinkedIn:', error);
        handleServiceUnavailable();
        return false;
      }
    }

    // ==================== مدیریت قطعی سرویس ====================
    function handleServiceUnavailable() {
      retryCount++;
      
      if (retryCount >= LINKEDIN_CONFIG.MAX_RETRIES) {
        retryCounter.textContent = 'تلاش‌های شما به حد مجاز رسید. لطفاً بعداً تلاش کنید.';
        authBtn.disabled = true;
        return;
      }
      
      serviceUnavailable.classList.remove('hidden');
      authBtn.disabled = true;
      
      let seconds = 30;
      retryCounter.textContent = `تلاش مجدد در ${seconds} ثانیه...`;
      
      retryTimer = setInterval(() => {
        seconds--;
        retryCounter.textContent = `تلاش مجدد در ${seconds} ثانیه...`;
        
        if (seconds <= 0) {
          clearInterval(retryTimer);
          checkLinkedInHealth();
        }
      }, 1000);
    }

    // ==================== مدیریت احراز هویت با بررسی سلامت سرویس ====================
    authBtn.addEventListener('click', async () => {
      // ابتدا سلامت سرویس را بررسی می‌کنیم
      const isHealthy = await checkLinkedInHealth();
      
      if (isHealthy) {
        const authUrl = `https://www.linkedin.com/oauth/v2/authorization?response_type=code&client_id=${LINKEDIN_CONFIG.CLIENT_ID}&redirect_uri=${LINKEDIN_CONFIG.REDIRECT_URI}&scope=${LINKEDIN_CONFIG.SCOPE}&state=${LINKEDIN_CONFIG.STATE}`;
        window.location.href = authUrl;
      }
    });

    // ==================== شروع چک سلامت دوره‌ای ====================
    function startHealthCheck() {
      // چک اولیه
      checkLinkedInHealth();
      
      // چک دوره‌ای
      setInterval(checkLinkedInHealth, LINKEDIN_CONFIG.HEALTH_CHECK_INTERVAL);
    }

    // ==================== مقداردهی اولیه ====================
    document.addEventListener('DOMContentLoaded', () => {
      startHealthCheck();
      checkAuthStatus();
      handleCallback();
    });

    // ... سایر توابع (مانند نمایش پروفایل، مدیریت خروج و ...) مانند قبل باقی می‌مانند
  </script>
</body>
</html>
