<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>سیستم مدیریت حرفه‌ای لینکدین</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <style>
    @font-face {
      font-family: 'Vazir';
      src: url('https://cdn.jsdelivr.net/gh/rastikerdar/vazir-font@v30.1.0/dist/Vazir.woff2') format('woff2');
    }
    body {
      font-family: 'Vazir', sans-serif;
    }
    .linkedin-auth {
      background-color: #0A66C2;
    }
    .linkedin-auth:hover {
      background-color: #004182;
    }
    .service-unavailable {
      background-color: #fef3c7;
      border-left: 4px solid #f59e0b;
    }
    .vpn-suggestion {
      background-color: #ecfdf5;
      border-left: 4px solid #10b981;
    }
  </style>
</head>
<body class="bg-gray-50">
  <div class="max-w-6xl mx-auto p-4 md:p-6 space-y-6">
    
    <!-- Header -->
    <header class="text-center py-6">
      <h1 class="text-2xl md:text-3xl font-bold text-[#0A66C2]">مدیریت حرفه‌ای لینکدین</h1>
      <p class="text-gray-600 mt-2">اتصال هوشمند رزومه، تولید محتوا و تحلیل پیشرفته</p>
    </header>

    <!-- LinkedIn Auth Section -->
    <section class="bg-white rounded-xl shadow-sm p-6">
      <h2 class="text-xl font-semibold text-gray-800 mb-4">اتصال به حساب لینکدین</h2>
      <div id="authSection">
        <button id="linkedInAuth" class="linkedin-auth flex items-center justify-center w-full max-w-xs mx-auto text-white font-medium py-2.5 px-4 rounded-lg transition duration-200">
          <i class="fab fa-linkedin-in ml-2 text-lg"></i>
          <span>اتصال با لینکدین</span>
        </button>
        <p class="text-sm text-gray-500 mt-3">برای استفاده از تمام قابلیت‌ها، لطفاً حساب لینکدین خود را متصل کنید</p>
      </div>
      
      <!-- Service Status Messages -->
      <div id="serviceUnavailable" class="hidden mt-4 p-4 rounded-lg service-unavailable">
        <div class="flex items-start">
          <i class="fas fa-exclamation-triangle text-yellow-600 mt-1 ml-2"></i>
          <div>
            <h3 class="font-medium text-yellow-800">مشکل در اتصال به LinkedIn</h3>
            <p class="text-sm text-yellow-700 mt-1" id="serviceMessage"></p>
            <div class="mt-3 flex items-center text-sm text-yellow-800">
              <i class="fas fa-sync-alt ml-2"></i>
              <span id="retryCounter"></span>
            </div>
          </div>
        </div>
      </div>
      
      <div id="vpnSuggestion" class="hidden mt-4 p-4 rounded-lg vpn-suggestion">
        <div class="flex items-start">
          <i class="fas fa-globe-europe text-green-600 mt-1 ml-2"></i>
          <div>
            <h3 class="font-medium text-green-800">راهکار جایگزین</h3>
            <p class="text-sm text-green-700 mt-1">به نظر می‌رسد محدودیت منطقه‌ای دارید. استفاده از VPN ممکن است مشکل را حل کند.</p>
            <button id="tryWithVPN" class="mt-2 bg-green-600 text-white px-3 py-1 rounded text-sm">
              <i class="fas fa-redo ml-1"></i> تلاش با VPN
            </button>
          </div>
        </div>
      </div>
      
      <div id="profileSection" class="hidden mt-4 p-4 bg-gray-50 border rounded-lg">
        <!-- Profile content -->
      </div>
    </section>

  </div>

  <script>
    // ==================== تنظیمات پیشرفته ====================
    const LINKEDIN_CONFIG = {
      CLIENT_ID: '78iihkedifumfl',
      CLIENT_SECRET: 'WPL_AP1.7tqHsAYYjoe31Ciz.C9cQPA==',
      REDIRECT_URI: encodeURIComponent('https://hosseincagey.github.io/linkdin/auth'),
      SCOPE: encodeURIComponent('r_liteprofile r_emailaddress'),
      STATE: '123456',
      HEALTH_CHECK_INTERVAL: 30000,
      MAX_RETRIES: 3,
      ALTERNATE_ENDPOINTS: [
        'https://www.linkedin.com',
        'https://api.linkedin.com',
        'https://www.linkedin.cn' // برای مناطق با محدودیت
      ]
    };

    // ==================== عناصر DOM ====================
    const authBtn = document.getElementById('linkedInAuth');
    const serviceUnavailable = document.getElementById('serviceUnavailable');
    const serviceMessage = document.getElementById('serviceMessage');
    const retryCounter = document.getElementById('retryCounter');
    const vpnSuggestion = document.getElementById('vpnSuggestion');
    const tryWithVPN = document.getElementById('tryWithVPN');
    
    let currentEndpointIndex = 0;
    let retryCount = 0;
    let retryTimer;

    // ==================== بررسی سلامت با endpointهای مختلف ====================
    async function checkLinkedInHealth() {
      try {
        const endpoint = LINKEDIN_CONFIG.ALTERNATE_ENDPOINTS[currentEndpointIndex];
        
        // استفاده از API سلامت LinkedIn با timeout
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5000);
        
        const response = await fetch(`${endpoint}/health`, {
          method: 'GET',
          mode: 'no-cors',
          cache: 'no-cache',
          signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        // اگر به این نقطه رسیدیم یعنی سرویس در دسترس است
        resetServiceStatus();
        return true;
      } catch (error) {
        console.error(`خطا در بررسی سلامت (Endpoint ${currentEndpointIndex}):`, error);
        
        // اگر endpoint فعلی کار نکرد، بعدی را امتحان کنیم
        if (currentEndpointIndex < LINKEDIN_CONFIG.ALTERNATE_ENDPOINTS.length - 1) {
          currentEndpointIndex++;
          return checkLinkedInHealth();
        }
        
        // اگر همه endpointها امتحان شدند و کار نکردند
        handleServiceError(error);
        return false;
      }
    }

    // ==================== مدیریت خطای سرویس ====================
    function handleServiceError(error) {
      retryCount++;
      
      // تشخیص نوع خطا
      const isNetworkError = error.message.includes('Failed to fetch') || error.message.includes('NetworkError');
      const isTimeoutError = error.message.includes('aborted');
      
      if (isNetworkError || isTimeoutError) {
        serviceMessage.textContent = 'مشکل در اتصال به سرورهای LinkedIn. ممکن است محدودیت منطقه‌ای وجود داشته باشد.';
        vpnSuggestion.classList.remove('hidden');
      } else {
        serviceMessage.textContent = 'سرویس LinkedIn موقتاً در دسترس نیست. لطفاً چند دقیقه دیگر تلاش کنید.';
      }
      
      serviceUnavailable.classList.remove('hidden');
      authBtn.disabled = true;
      
      if (retryCount >= LINKEDIN_CONFIG.MAX_RETRIES) {
        retryCounter.textContent = 'حداکثر تعداد تلاش‌ها انجام شد. لطفاً بعداً تلاش کنید.';
        return;
      }
      
      let seconds = 30;
      retryCounter.textContent = `تلاش مجدد در ${seconds} ثانیه...`;
      
      retryTimer = setInterval(() => {
        seconds--;
        retryCounter.textContent = `تلاش مجدد در ${seconds} ثانیه...`;
        
        if (seconds <= 0) {
          clearInterval(retryTimer);
          currentEndpointIndex = 0; // بازگشت به endpoint اول
          checkLinkedInHealth();
        }
      }, 1000);
    }

    // ==================== بازنشانی وضعیت سرویس ====================
    function resetServiceStatus() {
      serviceUnavailable.classList.add('hidden');
      vpnSuggestion.classList.add('hidden');
      authBtn.disabled = false;
      retryCount = 0;
      currentEndpointIndex = 0;
      clearInterval(retryTimer);
    }

    // ==================== تلاش با VPN ====================
    tryWithVPN.addEventListener('click', () => {
      serviceMessage.textContent = 'در حال تلاش برای اتصال از طریق مسیرهای جایگزین...';
      retryCounter.textContent = 'لطفاً صبر کنید...';
      currentEndpointIndex = LINKEDIN_CONFIG.ALTERNATE_ENDPOINTS.length - 1; // استفاده از endpoint جایگزین
      checkLinkedInHealth();
    });

    // ==================== مدیریت احراز هویت با بررسی کامل ====================
    authBtn.addEventListener('click', async () => {
      const isHealthy = await checkLinkedInHealth();
      
      if (isHealthy) {
        const endpoint = LINKEDIN_CONFIG.ALTERNATE_ENDPOINTS[currentEndpointIndex];
        const authUrl = `${endpoint}/oauth/v2/authorization?response_type=code&client_id=${LINKEDIN_CONFIG.CLIENT_ID}&redirect_uri=${LINKEDIN_CONFIG.REDIRECT_URI}&scope=${LINKEDIN_CONFIG.SCOPE}&state=${LINKEDIN_CONFIG.STATE}`;
        
        // باز کردن در تب جدید برای جلوگیری از مسدود شدن
        window.open(authUrl, '_blank');
      }
    });

    // ==================== شروع نظارت بر سرویس ====================
    function startServiceMonitoring() {
      // چک اولیه
      checkLinkedInHealth();
      
      // چک دوره‌ای
      setInterval(() => {
        if (!serviceUnavailable.classList.contains('hidden')) {
          checkLinkedInHealth();
        }
      }, LINKEDIN_CONFIG.HEALTH_CHECK_INTERVAL);
    }

    // ==================== مقداردهی اولیه ====================
    document.addEventListener('DOMContentLoaded', () => {
      startServiceMonitoring();
      // سایر توابع مقداردهی اولیه...
    });
  </script>
</body>
</html>
